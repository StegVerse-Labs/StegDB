name: sync-to-canonical

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 10 * * 1" # Mondays 10:00 UTC
  repository_dispatch:
    types: [sync-to-canonical]

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest

    env:
      CANONICAL_REPO: "StegVerse-Labs/StegDB"
      CANONICAL_ZIP_URL: "https://github.com/StegVerse-Labs/StegDB/releases/latest/download/canonical-bundle.zip"
      CANONICAL_SHA_URL: "https://github.com/StegVerse-Labs/StegDB/releases/latest/download/canonical-bundle.sha256"
      MANIFEST_URL: "https://raw.githubusercontent.com/StegVerse-Labs/StegDB/main/tools/repo_manifest.json"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download canonical bundle + sha (verify)
        shell: bash
        run: |
          set -euo pipefail
          curl -fsSL "$CANONICAL_ZIP_URL" -o /tmp/canonical-bundle.zip
          curl -fsSL "$CANONICAL_SHA_URL" -o /tmp/canonical-bundle.sha256
          (cd /tmp && sha256sum -c canonical-bundle.sha256)

      - name: Unpack canonical bundle
        shell: bash
        run: |
          set -euo pipefail
          rm -rf /tmp/canonical
          mkdir -p /tmp/canonical
          unzip -q /tmp/canonical-bundle.zip -d /tmp/canonical
          test -d /tmp/canonical/canonical || (echo "::error::Expected /canonical folder in bundle"; exit 2)

      - name: Determine profiles for this repo (from StegDB manifest)
        id: prof
        shell: bash
        run: |
          set -euo pipefail
          curl -fsSL "$MANIFEST_URL" -o /tmp/repo_manifest.json

          python - <<'PY'
          import json, os
          from pathlib import Path

          repo = os.environ.get("GITHUB_REPOSITORY","").strip()
          man = json.loads(Path("/tmp/repo_manifest.json").read_text(encoding="utf-8"))

          default_profiles = man.get("default_profiles") or ["base"]
          profiles = None

          for r in (man.get("repos") or []):
              if (r.get("name") or "").strip().lower() == repo.lower():
                  profiles = r.get("profiles") or default_profiles
                  break

          if not profiles:
              profiles = default_profiles

          # sanitize
          profiles = [p.strip() for p in profiles if isinstance(p,str) and p.strip()]
          if not profiles:
              profiles = ["base"]

          Path("/tmp/profiles.txt").write_text("\n".join(profiles) + "\n", encoding="utf-8")
          print("Profiles:", profiles)
          PY

          echo "profiles=$(paste -sd, /tmp/profiles.txt)" >> "$GITHUB_OUTPUT"

      - name: Apply profiles from canonical into repo (no deletions)
        shell: bash
        run: |
          set -euo pipefail

          PROFILES="${{ steps.prof.outputs.profiles }}"
          echo "Applying profiles: $PROFILES"

          # Convert comma list to newline
          python - <<'PY'
          import os
          ps = os.environ["PROFILES"].split(",")
          ps = [p.strip() for p in ps if p.strip()]
          open("/tmp/profiles_apply.txt","w",encoding="utf-8").write("\n".join(ps)+"\n")
          PY
        env:
          PROFILES: ${{ steps.prof.outputs.profiles }}

      - name: Sync profile contents
        shell: bash
        run: |
          set -euo pipefail

          while IFS= read -r profile; do
            profile="$(echo "$profile" | xargs)"
            [[ -z "$profile" ]] && continue

            src="/tmp/canonical/canonical/profiles/${profile}"
            if [[ ! -d "$src" ]]; then
              echo "::warning title=Missing profile in canonical::profiles/${profile} not found in bundle; skipping"
              continue
            fi

            echo "== Syncing profile: $profile =="
            rsync -a "$src/" "./"
          done < /tmp/profiles_apply.txt

      - name: Write canonical lock file + stamp workflow headers
        shell: bash
        run: |
          set -euo pipefail
          SHA="$(awk '{print $1}' /tmp/canonical-bundle.sha256)"
          PROFILES="$(paste -sd, /tmp/profiles_apply.txt)"

          python - <<PY
          import json, time, os, re
          from pathlib import Path

          sha = os.environ["SHA"].strip()
          profiles = [p.strip() for p in os.environ["PROFILES"].split(",") if p.strip()]

          lock = {
            "canonical_source": "${CANONICAL_REPO}",
            "canonical_zip": "${CANONICAL_ZIP_URL}",
            "canonical_sha_url": "${CANONICAL_SHA_URL}",
            "sha256": sha,
            "profiles": profiles,
            "synced_at_utc": time.strftime("%Y-%m-%dT%H:%M:%SZ", time.gmtime()),
          }
          Path("stegverse.canonical.lock.json").write_text(json.dumps(lock, indent=2, sort_keys=True)+"\n", encoding="utf-8")

          wf_dir = Path(".github/workflows")
          if wf_dir.exists():
            for wf in sorted(list(wf_dir.glob("*.yml")) + list(wf_dir.glob("*.yaml"))):
              lines = wf.read_text(encoding="utf-8").splitlines(True)
              # find first "name:"
              name_i = None
              for i,l in enumerate(lines):
                if re.match(r"^\s*name:\s*.+\s*$", l):
                  name_i = i
                  break
              if name_i is None:
                continue

              desired = f"# stegverse: canonical_sha256={sha} source=${CANONICAL_REPO} path={wf.as_posix()}\n"
              # header line is immediately after name:
              insert_i = name_i + 1
              if insert_i < len(lines) and re.match(r"^\s*#\s*stegverse:\s*.+\s*$", lines[insert_i]):
                if lines[insert_i] != desired:
                  lines[insert_i] = desired
              else:
                lines.insert(insert_i, desired)

              wf.write_text("".join(lines), encoding="utf-8")

          print("Wrote stegverse.canonical.lock.json and stamped workflow headers.")
          PY
        env:
          SHA: ${{ env.SHA }}
          PROFILES: ${{ steps.prof.outputs.profiles }}

      - name: Create PR if changes exist
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          if git diff --quiet; then
            echo "No changes after sync. Done."
            exit 0
          fi

          BR="canonical-sync-$(date -u +%Y%m%d%H%M%S)"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git checkout -b "$BR"
          git add -A
          git commit -m "chore: sync canonical profiles [skip ci]"
          git push -u origin "$BR"

          TITLE="chore: sync canonical profiles"
          BODY=$'Generated by sync-to-canonical.\n\n- source: '"${CANONICAL_REPO}"$'\n- lock: `stegverse.canonical.lock.json`\n\nMerge to apply canonical profile updates.'
          gh pr create --title "$TITLE" --body "$BODY" || {
            echo "::warning::PR may already exist or permissions blocked. Create it manually from branch $BR."
          }
