name: CosDen Docker Build (PROD-gated)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch: {}

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout CosDen
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install minimal deps
        run: |
          python -m pip install --upgrade pip
          pip install pydantic fastapi uvicorn

      # 1) Run strict validation (this also updates validation_stamp.json)
      - name: Run validator (STRICT prod mode)
        env:
          GITHUB_SHA: ${{ github.sha }}
        run: |
          python tools/validate_cosden_structure.py --mode=prod

      # 2) Verify the stamp is prod-level for this commit
      - name: Verify prod validation stamp
        env:
          GITHUB_SHA: ${{ github.sha }}
        run: |
          python - << 'PY'
          import json, pathlib, os, sys

          root = pathlib.Path(".")
          stamp_path = root / "meta" / "validation_stamp.json"
          if not stamp_path.exists():
              print("❌ No meta/validation_stamp.json found — cannot publish.")
              sys.exit(1)

          with stamp_path.open("r", encoding="utf-8") as f:
              stamp = json.load(f)

          expected_commit = os.environ.get("GITHUB_SHA", "").strip()
          commit = stamp.get("commit")
          highest_mode = stamp.get("highest_mode")

          if highest_mode != "prod":
              print(f"❌ Validation highest_mode is {highest_mode!r}, expected 'prod'.")
              sys.exit(1)

          if commit != expected_commit:
              print(f"❌ Validation commit {commit} != current {expected_commit}")
              sys.exit(1)

          print("✅ Prod validation stamp OK for this commit.")
          PY

      # 3) Build container (only reached if above passes)
      - name: Build container
        run: |
          docker build -t cosden:latest .
