name: StegDB Central Control

on:
  workflow_dispatch:
    inputs:
      action:
        description: "What do you want to run?"
        required: true
        type: choice
        options:
          - export_cosden_canonical
          - ingest_metadata
          - generate_repair_plan
          - run_full_cycle

jobs:
  stegdb-central:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout StegDB
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout CosDen (if needed)
        if: ${{ inputs.action == 'export_cosden_canonical' || inputs.action == 'run_full_cycle' }}
        uses: actions/checkout@v4
        with:
          repository: StegVerse/CosDen
          path: CosDen
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # --- ACTION: export_cosden_canonical ---
      - name: Export CosDen canonical files
        if: ${{ inputs.action == 'export_cosden_canonical' }}
        run: |
          python tools/export_cosden_canonical.py --cosden-root ./CosDen

      # --- ACTION: ingest_metadata ---
      - name: Ingest repo metadata
        if: ${{ inputs.action == 'ingest_metadata' }}
        run: |
          python tools/ingest_repo_metadata.py

      # --- ACTION: generate_repair_plan ---
      - name: Ingest metadata (for repair plan)
        if: ${{ inputs.action == 'generate_repair_plan' }}
        run: |
          python tools/ingest_repo_metadata.py

      - name: Generate repair plan(s)
        if: ${{ inputs.action == 'generate_repair_plan' }}
        run: |
          python tools/repair_repos.py

      # --- ACTION: run_full_cycle ---
      - name: Run full cycle (CosDen)
        if: ${{ inputs.action == 'run_full_cycle' }}
        run: |
          python tools/run_full_cycle.py --cosden-root ./CosDen

      # --- Create PR for any changes in StegDB ---
      - name: Create pull request for StegDB changes
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "StegDB: ${{ inputs.action }} run"
          title: "StegDB: ${{ inputs.action }} run"
          body: "Automated run of `${{ inputs.action }}` via StegDB Central Control workflow."
          branch: "stegdb/${{ inputs.action }}"
          labels: "stegdb,auto"
