name: StegDB Full Cycle (Self-Healing)

on:
  workflow_dispatch:

jobs:
  full-cycle:
    runs-on: ubuntu-latest

    steps:
    # -------------------------
    # 1. Checkout StegDB
    # -------------------------
    - name: Checkout StegDB
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # -------------------------
    # 2. Set up Python
    # -------------------------
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install minimal dependencies
      run: python -m pip install --upgrade pip

    # -------------------------
    # 3. Bootstrap core dirs
    # -------------------------
    - name: Bootstrap directories
      run: |
        set -e
        mkdir -p meta
        mkdir -p repos
        mkdir -p repairs

    # -------------------------
    # 4. Read repo list from tools/repos_config.json
    # -------------------------
    - name: Read repo list
      id: repo_list
      run: |
        set -e
        CONFIG="tools/repos_config.json"
        if [ ! -f "$CONFIG" ]; then
          echo "::error::Missing tools/repos_config.json"
          exit 1
        fi

        REPOS=$(jq -r '.repos[].name' "$CONFIG" | tr '\n' ' ')
        if [ -z "$REPOS" ]; then
          echo "::error::No repos configured in tools/repos_config.json"
          exit 1
        fi

        echo "repos=$REPOS" >> "$GITHUB_OUTPUT"
        echo "Repos: $REPOS"

    # -------------------------
    # 5. Export canonical from each repo
    # -------------------------
    - name: Export canonical
      run: |
        set -e
        echo "===== Canonical Export ====="

        for repo in ${{ steps.repo_list.outputs.repos }}; do
          echo "üì¶ Exporting canonical for: $repo"
          python tools/export_cosden_canonical.py \
            --cosden-root "$repo"
        done

    # -------------------------
    # 6. Generate per-repo metadata
    # -------------------------
    - name: Generate metadata
      run: |
        set -e
        echo "===== Metadata Generation ====="

        mkdir -p repos

        for repo in ${{ steps.repo_list.outputs.repos }}; do
          echo "üßæ Generating metadata for $repo"
          mkdir -p "repos/${repo}"
          python tools/generate_repo_metadata.py \
            --repo-name "$repo" \
            --repo-root "$repo" \
            --output "repos/${repo}/files.jsonl"
        done

    # -------------------------
    # 7. Aggregate metadata into meta/aggregated_files.jsonl
    # -------------------------
    - name: Aggregate metadata
      run: |
        set -e
        echo "===== Metadata Aggregation ====="
        mkdir -p meta
        python tools/ingest_repo_metadata.py

    # -------------------------
    # 8. Run repair engine
    # -------------------------
    - name: Run repair engine
      run: |
        set -e
        echo "===== Repair Engine ====="
        python tools/repair_repos.py

    # -------------------------
    # 9. First pass: Evaluate dependency status
    # -------------------------
    - name: Evaluate dependency status (first pass)
      run: |
        set -e
        echo "===== Evaluate dependency status (first pass) ====="
        python tools/evaluate_dependencies.py

    # -------------------------
    # 10. Verify key artifacts (first pass)
    #     If this fails, we drop into the self-heal step.
    # -------------------------
    - name: Verify artifacts (first pass)
      id: verify_first
      continue-on-error: true
      run: |
        set -e
        echo "===== Verify artifacts (first pass) ====="
        OK=1

        if [ ! -s meta/aggregated_files.jsonl ]; then
          echo "::warning::meta/aggregated_files.jsonl missing or empty"
          OK=0
        fi

        if [ ! -s meta/dependency_status.json ]; then
          echo "::warning::meta/dependency_status.json missing or empty"
          OK=0
        fi

        if [ $OK -eq 0 ]; then
          echo "First pass verification FAILED"
          exit 1
        else
          echo "First pass verification OK"
        fi

    # -------------------------
    # 11. Self-healing path (only if first verify failed)
    # -------------------------
    - name: Self-heal + re-evaluate dependencies
      if: ${{ steps.verify_first.outcome == 'failure' }}
      run: |
        set -e
        echo "===== SELF-HEALING PATH ====="

        echo "üîÅ Re-aggregating metadata..."
        mkdir -p meta
        python tools/ingest_repo_metadata.py

        echo "üîÅ Re-running dependency evaluation..."
        python tools/evaluate_dependencies.py

        echo "üß† Writing diagnostics..."
        cat << EOF > meta/diagnostics.json
        {
          "source": "full-cycle.yml",
          "self_heal_applied": true,
          "timestamp_utc": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
        }
        EOF

    # -------------------------
    # 12. Final verification (hard gate)
    # -------------------------
    - name: Verify artifacts (final, hard gate)
      run: |
        set -e
        echo "===== Final artifact verification ====="
        ERR=0

        if [ ! -s meta/aggregated_files.jsonl ]; then
          echo "::error::meta/aggregated_files.jsonl still missing or empty after self-heal"
          ERR=1
        fi

        if [ ! -s meta/dependency_status.json ]; then
          echo "::error::meta/dependency_status.json still missing or empty after self-heal"
          ERR=1
        fi

        if [ $ERR -ne 0 ]; then
          echo "Final verification FAILED"
          exit 1
        else
          echo "Final verification OK"
        fi

    # -------------------------
    # 13. Commit & push meta/ + dependency_status.json
    # -------------------------
    - name: Commit and push StegDB meta
      if: github.ref == 'refs/heads/main'
      run: |
        set -e
        echo "===== Commit & push meta ====="

        git status --short

        # stage only the meta + dependency graph pieces
        git add meta/*.json meta/*.jsonl tools/dependency_graph.json 2>/dev/null || true

        if [ -z "$(git diff --cached --name-only)" ]; then
          echo "No meta changes to commit."
          exit 0
        fi

        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        git commit -m "Update StegDB meta & dependency status [skip ci]" || {
          echo "Nothing to commit."
          exit 0
        }

        git push

    # -------------------------
    # 14. Done
    # -------------------------
    - name: Done
      run: echo "üéâ Full cycle (self-healing) complete."
