name: sync-diamondops-core-canonicals

on:
  workflow_dispatch:
    inputs:
      only_repo:
        description: "Optional: only run for this repo name (e.g., CosDen). Leave blank for all."
        required: false
        default: ""
        type: string
      dry_run:
        description: "If true, do not push/PR (prints what would change)."
        required: false
        default: "false"
        type: choice
        options: ["false", "true"]

permissions:
  contents: read

jobs:
  sync:
    runs-on: ubuntu-latest

    env:
      # Needs a PAT with permission to push branches + open PRs in target repos.
      # github.token usually CANNOT push to other repos.
      GH_TOKEN: ${{ secrets.STEGVERSE_BOT_TOKEN }}

      # Canonical source repo
      DIAMONDOPS_CORE: "stegverse-labs/diamondops-core"
      DIAMONDOPS_CORE_REF: "main"

      # Where StegDB keeps the list of target repos
      REPOS_JSON: "registry/repos.json"

    steps:
      - name: Checkout StegDB
        uses: actions/checkout@v4

      - name: Preflight - require bot token
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z "${GH_TOKEN:-}" ]]; then
            echo "::error::Missing secret STEGVERSE_BOT_TOKEN (PAT required to push/PR into other repos)."
            exit 2
          fi
          echo "Bot token present."

      - name: Install jq
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Checkout DiamondOps-Core
        shell: bash
        run: |
          set -euo pipefail
          rm -rf /tmp/diamondops-core
          git clone --depth 1 --branch "${DIAMONDOPS_CORE_REF}" "https://github.com/${DIAMONDOPS_CORE}.git" /tmp/diamondops-core
          test -f /tmp/diamondops-core/docs/POSITION.md
          test -f /tmp/diamondops-core/docs/LIABILITY_BOUNDARY.md
          test -f /tmp/diamondops-core/docs/CANONICAL_DOCS.md
          echo "DiamondOps-Core checkout OK."

      - name: Sync canonicals into target repos + open PRs
        shell: bash
        run: |
          set -euo pipefail

          ONLY="${{ inputs.only_repo }}"
          DRY="${{ inputs.dry_run }}"

          if [[ ! -f "${REPOS_JSON}" ]]; then
            echo "::error::Missing ${REPOS_JSON}"
            exit 2
          fi

          # Validate each entry has full_name
          if jq -e '.repos[] | has("full_name")' "${REPOS_JSON}" >/dev/null 2>&1; then
            echo "repos.json contains full_name fields."
          else
            echo "::error::Each repo entry must include \"full_name\": \"owner/repo\""
            exit 2
          fi

          count="$(jq '.repos | length' "${REPOS_JSON}")"
          echo "Found ${count} repos."

          jq -c '.repos[]' "${REPOS_JSON}" | while read -r repo; do
            name="$(echo "$repo" | jq -r '.name')"
            full="$(echo "$repo" | jq -r '.full_name')"

            if [[ -n "$ONLY" && "$name" != "$ONLY" ]]; then
              echo "Skipping $name (only_repo=$ONLY)"
              continue
            fi

            echo "----"
            echo "Target: $name ($full)"

            work="/tmp/target"
            rm -rf "$work"
            mkdir -p "$work"

            # Clone target repo using PAT (via GH_TOKEN)
            git clone "https://x-access-token:${GH_TOKEN}@github.com/${full}.git" "$work"

            # Run the sync tool (writes files in repo)
            python tools/sync_canonical_docs.py \
              --registry registry/diamondops_core_canonical_docs.json \
              --source-root /tmp/diamondops-core \
              --repo-root "$work" \
              --repo-name "$name" \
              $( [[ "$DRY" == "true" ]] && echo "--dry-run" || true )

            if [[ "$DRY" == "true" ]]; then
              echo "Dry-run for $name completed."
              continue
            fi

            cd "$work"
            if git diff --quiet; then
              echo "No changes for $name."
              continue
            fi

            BR="canonicals/diamondops-core-$(date -u +%Y%m%d%H%M%S)"
            git config user.name "stegverse-bot"
            git config user.email "stegverse-bot@users.noreply.github.com"

            git checkout -b "$BR"
            git add -A
            git commit -m "chore(docs): sync DiamondOps-Core canonical docs"
            git push -u origin "$BR"

            TITLE="chore(docs): sync DiamondOps-Core canonicals"
            BODY=$'This PR was generated by StegDB.\n\n- Canonical source: https://github.com/'"${DIAMONDOPS_CORE}"$'\n- Registry: `registry/diamondops_core_canonical_docs.json`\n\nDo not edit these files locallyâ€”update DiamondOps-Core canonicals and re-run.'
            gh pr create --repo "$full" --title "$TITLE" --body "$BODY" || {
              echo "::warning::PR creation failed (maybe already exists). Branch: $BR"
            }

          done
