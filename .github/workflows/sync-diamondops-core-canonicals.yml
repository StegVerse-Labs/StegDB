name: sync-diamondops-core-canonicals

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "If true, do not push/PR (prints what would change)."
        required: false
        default: "false"
        type: choice
        options: ["false", "true"]

permissions:
  contents: read

jobs:
  sync:
    runs-on: ubuntu-latest

    env:
      # PAT required to push branches + open PRs in OTHER repos.
      GH_TOKEN: ${{ secrets.STEGVERSE_BOT_TOKEN }}

      # Canonical source
      CANON_SOURCE_REPO: "stegverse-labs/diamondops-core"
      CANON_SOURCE_REF: "main"
      CANON_REGISTRY: "registry/diamondops_core_canonical_docs.json"

      # Target repos (exactly the 3 you confirmed)
      TARGETS: |
        stegverse-labs/hydrasafe
        stegverse-labs/reactorops
        stegverse-labs/yieldos

    steps:
      - name: Checkout StegDB
        uses: actions/checkout@v4

      - name: Preflight - require bot token
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z "${GH_TOKEN:-}" ]]; then
            echo "::error::Missing secret STEGVERSE_BOT_TOKEN (PAT required to push/PR into other repos)."
            exit 2
          fi
          echo "Bot token present."

      - name: Checkout DiamondOps-Core (canonical source)
        shell: bash
        run: |
          set -euo pipefail
          rm -rf /tmp/diamondops-core
          git clone --depth 1 --branch "${CANON_SOURCE_REF}" "https://github.com/${CANON_SOURCE_REPO}.git" /tmp/diamondops-core
          test -f /tmp/diamondops-core/docs/POSITION.md
          test -f /tmp/diamondops-core/docs/LIABILITY_BOUNDARY.md
          echo "Canonical source checkout OK."

      - name: Sync canonicals into target repos + open PRs
        shell: bash
        run: |
          set -euo pipefail
          DRY="${{ inputs.dry_run }}"

          while IFS= read -r full; do
            full="$(echo "$full" | xargs)"
            [[ -z "$full" ]] && continue

            name="$(basename "$full")"
            echo "----"
            echo "Target: $full"

            work="/tmp/target"
            rm -rf "$work"
            mkdir -p "$work"

            git clone "https://x-access-token:${GH_TOKEN}@github.com/${full}.git" "$work"

            python tools/sync_canonical_docs.py \
              --registry "${CANON_REGISTRY}" \
              --source-root /tmp/diamondops-core \
              --repo-root "$work" \
              --repo-name "$name" \
              $( [[ "$DRY" == "true" ]] && echo "--dry-run" || true )

            if [[ "$DRY" == "true" ]]; then
              echo "Dry-run for $full completed."
              continue
            fi

            cd "$work"
            if git diff --quiet; then
              echo "No changes for $full."
              continue
            fi

            BR="canonicals/diamondops-core-$(date -u +%Y%m%d%H%M%S)"
            git config user.name "stegverse-bot"
            git config user.email "stegverse-bot@users.noreply.github.com"

            git checkout -b "$BR"
            git add -A
            git commit -m "chore(docs): sync DiamondOps-Core canonical docs"
            git push -u origin "$BR"

            TITLE="chore(docs): sync DiamondOps-Core canonicals"
            BODY=$'This PR was generated by StegDB.\n\n- Canonical source: https://github.com/'"${CANON_SOURCE_REPO}"$'\n- Registry: `'"${CANON_REGISTRY}"$'`\n\nDo not edit these files locallyâ€”update DiamondOps-Core canonicals and re-run.'
            gh pr create --repo "$full" --title "$TITLE" --body "$BODY" || {
              echo "::warning::PR creation failed (maybe already exists). Branch: $BR"
            }

          done <<< "${TARGETS}"
