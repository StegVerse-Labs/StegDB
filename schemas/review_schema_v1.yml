schema_name: stegdb_repo_review
schema_version: 1.0.0
description: >
  Declarative schema for StegDB to perform a read-only repository review,
  flag legacy/obsolete candidates, and propose doc updates without gatekeeping
  or destructive changes.

# --- REQUIRED TOP-LEVEL FIELDS ---
required:
  - repo
  - intent
  - scope
  - modes
  - checks
  - outputs

repo:
  type: object
  required:
    - owner
    - name
  properties:
    owner:
      type: string
      description: GitHub org/user that owns the repo
    name:
      type: string
      description: Repository name
    default_branch:
      type: string
      default: main
    visibility:
      type: string
      enum: [public, private, internal, unknown]
      default: unknown
    tags:
      type: array
      items: { type: string }
      description: Optional classification tags (e.g., canonical, knowledge, ops)

intent:
  type: object
  required:
    - statement
    - status
  properties:
    statement:
      type: string
      description: 1â€“3 sentence purpose statement
    status:
      type: string
      enum: [active, mixed, exploratory, legacy, archived, unknown]
      description: Declared lifecycle status
    audience:
      type: array
      items: { type: string }
      description: Who this repo is for (e.g., public, family, developers)
    non_goals:
      type: array
      items: { type: string }
      description: Explicit "what this is not" bullets (optional)

scope:
  type: object
  required:
    - review_type
  properties:
    review_type:
      type: string
      enum: [read_only_audit, audit_plus_doc_suggestions, audit_docs_kv_visibility]
      description: Determines depth; all are non-destructive
    include_paths:
      type: array
      items: { type: string }
      description: Limit review to specific folders (optional)
    exclude_paths:
      type: array
      items: { type: string }
      description: Paths to ignore (optional)
    file_globs_exclude:
      type: array
      items: { type: string }
      default: [".git/**", "**/.DS_Store", "**/node_modules/**", "**/__pycache__/**"]

modes:
  type: object
  required:
    - destructive_actions
    - network_access
  properties:
    destructive_actions:
      type: string
      enum: [forbidden, allowed]
      default: forbidden
      description: Must be forbidden for StegDB review mode D
    network_access:
      type: string
      enum: [none, github_only, internet]
      default: github_only
      description: In CI, typically github_only
    output_format:
      type: string
      enum: [yaml, json, markdown, all]
      default: all

checks:
  type: object
  required:
    - structural_audit
    - doc_reality_check
    - legacy_signaling
    - first_contact
    - failure_modes
  properties:

    structural_audit:
      type: object
      required: [enabled]
      properties:
        enabled: { type: boolean }
        required_files:
          type: array
          items: { type: string }
          default: ["README.md"]
        recommended_files:
          type: array
          items: { type: string }
          default: ["STATUS.md", "CHANGELOG.md", "LICENSE"]
        folder_expectations:
          type: array
          items: { type: string }
          description: Optional expected folders like docs/, schemas/, tools/

    doc_reality_check:
      type: object
      required: [enabled]
      properties:
        enabled: { type: boolean }
        must_include_sections:
          type: array
          items: { type: string }
          default: ["What it is", "What it is not", "How to start"]
        disallow_phrases:
          type: array
          items: { type: string }
          description: Words/phrases that create gatekeeping or overclaim

    legacy_signaling:
      type: object
      required: [enabled]
      properties:
        enabled: { type: boolean }
        heuristics:
          type: array
          items: { type: string }
          default:
            - "orphaned_files"
            - "duplicate_docs"
            - "stale_configs"
            - "todo_only_files"
            - "abandoned_prototypes"
        classification_labels:
          type: array
          items: { type: string }
          default: ["active", "experimental", "legacy", "candidate_for_deprecation"]

    first_contact:
      type: object
      required: [enabled]
      properties:
        enabled: { type: boolean }
        welcome_file:
          type: string
          default: "WELCOME.md"
        must_answer_questions:
          type: array
          items: { type: string }
          default:
            - "What is this?"
            - "What am I expected to do (or not do)?"
            - "Why does this exist?"
        device_agnostic_language:
          type: boolean
          default: true

    failure_modes:
      type: object
      required: [enabled]
      properties:
        enabled: { type: boolean }
        classify_severity:
          type: array
          items: { type: string }
          default: ["low", "moderate", "serious"]
        definition_serious_failure:
          type: array
          items: { type: string }
          default:
            - "User cannot open/read core docs"
            - "Template breaks on common OSes"
            - "Docs imply dependencies that do not exist"
            - "Announcement claims contradict repo reality"
            - "Data loss risk from normal use"

outputs:
  type: object
  required:
    - report_paths
    - confidence_signal
  properties:
    report_paths:
      type: object
      required: [markdown, yaml, json]
      properties:
        markdown: { type: string, default: "stegdb_review/report.md" }
        yaml: { type: string, default: "stegdb_review/result.yml" }
        json: { type: string, default: "stegdb_review/result.json" }
    confidence_signal:
      type: string
      enum: [green, yellow, red]
      description: Overall repo readiness for public-first contact
    include_suggested_patches:
      type: boolean
      default: true
      description: Whether to output non-destructive suggested edits (PR-style)
    patches_path:
      type: string
      default: "stegdb_review/suggested_patches/"
