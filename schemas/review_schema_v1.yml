$schema: https://json-schema.org/draft/2020-12/schema
$id: https://stegverse-labs.github.io/stegdb/schemas/review_schema_v1.json
title: StegDB Repo Review Request
description: >
  Validates a StegDB review request ("review.yml"). This is read-only audit configuration:
  it must not require destructive actions and should avoid gatekeeping semantics.

type: object
additionalProperties: false

required:
  - schema_name
  - schema_version
  - repo
  - intent
  - scope
  - modes
  - checks
  - outputs

properties:
  schema_name:
    const: stegdb_repo_review
  schema_version:
    type: string
    const: 1.0.0

  repo:
    type: object
    additionalProperties: false
    required: [owner, name]
    properties:
      owner:
        type: string
        minLength: 1
      name:
        type: string
        minLength: 1
      default_branch:
        type: string
        default: main
      visibility:
        type: string
        enum: [public, private, internal, unknown]
        default: unknown
      tags:
        type: array
        items:
          type: string
        default: []

  intent:
    type: object
    additionalProperties: false
    required: [statement, status]
    properties:
      statement:
        type: string
        minLength: 1
        description: 1â€“3 sentence purpose statement
      status:
        type: string
        enum: [active, mixed, exploratory, legacy, archived, unknown]
      audience:
        type: array
        items:
          type: string
        default: []
      non_goals:
        type: array
        items:
          type: string
        default: []

  scope:
    type: object
    additionalProperties: false
    required: [review_type]
    properties:
      review_type:
        type: string
        enum: [read_only_audit, audit_plus_doc_suggestions, audit_docs_kv_visibility]
      include_paths:
        type: array
        items:
          type: string
        default: []
      exclude_paths:
        type: array
        items:
          type: string
        default: []
      file_globs_exclude:
        type: array
        items:
          type: string
        default:
          - .git/**
          - "**/.DS_Store"
          - "**/node_modules/**"
          - "**/__pycache__/**"

  modes:
    type: object
    additionalProperties: false
    required: [destructive_actions, network_access]
    properties:
      destructive_actions:
        type: string
        enum: [forbidden, allowed]
        default: forbidden
      network_access:
        type: string
        enum: [none, github_only, internet]
        default: github_only
      output_format:
        type: string
        enum: [yaml, json, markdown, all]
        default: all

    # Guardrail: in review mode D we want forbidden. Keep schema permissive, but allow tooling to enforce stricter policy.
    # If you want hard enforcement, switch this to: const: forbidden
    # properties: { destructive_actions: { const: forbidden } }

  checks:
    type: object
    additionalProperties: false
    required:
      - structural_audit
      - doc_reality_check
      - legacy_signaling
      - first_contact
      - failure_modes
    properties:
      structural_audit:
        type: object
        additionalProperties: false
        required: [enabled]
        properties:
          enabled: { type: boolean }
          required_files:
            type: array
            items: { type: string }
            default: ["README.md"]
          recommended_files:
            type: array
            items: { type: string }
            default: ["WELCOME.md", "STATUS.md", "CHANGELOG.md", "LICENSE"]
          folder_expectations:
            type: array
            items: { type: string }
            default: []

      doc_reality_check:
        type: object
        additionalProperties: false
        required: [enabled]
        properties:
          enabled: { type: boolean }
          must_include_sections:
            type: array
            items: { type: string }
            default: ["What it is", "What it is not", "How to start"]
          disallow_phrases:
            type: array
            items: { type: string }
            default: []

      legacy_signaling:
        type: object
        additionalProperties: false
        required: [enabled]
        properties:
          enabled: { type: boolean }
          heuristics:
            type: array
            items: { type: string }
            default:
              - orphaned_files
              - duplicate_docs
              - stale_configs
              - todo_only_files
              - abandoned_prototypes
          classification_labels:
            type: array
            items: { type: string }
            default: [active, experimental, legacy, candidate_for_deprecation]

      first_contact:
        type: object
        additionalProperties: false
        required: [enabled]
        properties:
          enabled: { type: boolean }
          welcome_file:
            type: string
            default: WELCOME.md
          must_answer_questions:
            type: array
            items: { type: string }
            default:
              - "What is this?"
              - "What am I expected to do (or not do)?"
              - "Why does this exist?"
          device_agnostic_language:
            type: boolean
            default: true

      failure_modes:
        type: object
        additionalProperties: false
        required: [enabled]
        properties:
          enabled: { type: boolean }
          classify_severity:
            type: array
            items: { type: string }
            default: [low, moderate, serious]
          definition_serious_failure:
            type: array
            items: { type: string }
            default:
              - "User cannot open/read core docs"
              - "Template breaks on common OSes"
              - "Docs imply dependencies that do not exist"
              - "Announcement claims contradict repo reality"
              - "Data loss risk from normal use"

  outputs:
    type: object
    additionalProperties: false
    required: [report_paths, confidence_signal]
    properties:
      report_paths:
        type: object
        additionalProperties: false
        required: [markdown, yaml, json]
        properties:
          markdown: { type: string, default: stegdb_review/report.md }
          yaml: { type: string, default: stegdb_review/result.yml }
          json: { type: string, default: stegdb_review/result.json }
      confidence_signal:
        type: string
        enum: [green, yellow, red]
      include_suggested_patches:
        type: boolean
        default: true
      patches_path:
        type: string
        default: stegdb_review/suggested_patches/
